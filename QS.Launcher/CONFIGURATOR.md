# Configurator - Модуль управления конфигурацией подключений

## Назначение

Модуль отвечает за надежное чтение и сохранение конфигурации подключений к базам данных и облачным сервисам. Реализует атомарную запись с защитой от потери данных при конкурентном доступе.

## Основные возможности

- Безопасное чтение и запись конфигурации в формате JSON
- Атомарность операций - гарантия целостности данных
- Межпроцессная синхронизация - защита от конфликтов
- Автоматическое восстановление из резервной копии
- Миграция из INI-файлов предыдущих версий

## Публичные методы

### `ReadConnections() : IList<Connection>`
Читает конфигурацию подключений из файла.

**Последовательность:**
1. Чтение основного файла
2. При ошибке → восстановление из `.backup`
3. При отсутствии → импорт из `.ini`
4. Если ничего нет → дефолтная конфигурация

### `SaveConnections(IList<Connection> connections) : void`
Сохраняет конфигурацию с гарантией целостности данных.

**Последовательность:**
1. Создание файла блокировки `.lock`
2. Запись во временный файл `.tmp`
3. Синхронизация с диском (`Flush()`)
4. Резервное копирование текущего файла → `.backup`
5. Атомарная замена основного файла
6. Удаление `.backup` после успеха
7. Снятие блокировки

## Используемые файлы

| Файл | Расширение | Назначение | Время жизни |
|------|------------|------------|-------------|
| Основной | `connections.json` | Текущая конфигурация | Постоянно |
| Временный | `connections.json.tmp` | Запись новых данных | Только при записи |
| Резервная копия | `connections.json.backup` | Восстановление | При записи, удаляется после успеха |
| Блокировка | `connections.json.lock` | Синхронизация процессов | Только при записи |
| Старый формат | `*.ini` | Миграция | Постоянно |

## Последовательность операций

### Процесс чтения

```
┌─────────────────────────┐
│ Чтение connections.json │
└───────────┬─────────────┘
            │
            ├─ Успех ──────────────────┐
            │                          │
            └─ Ошибка/пустой           │
                        ▼              │
            ┌─────────────────────┐    │
            │ Восстановление из   │    │
            │ .backup             │────┤
            └─────────────────────┘    │
                        │              │
                        └─ Ошибка      │
                              ▼        │
                        ┌─────────────────────┐
                        │ Миграция из .ini    │──┐
                        └─────────────────────┘  │
                                    │            │
                                    └─ Ошибка    │
                                            ▼    ▼
                                ┌────────────────────┐
                                │ Дефолтная          │
                                │ конфигурация       │
                                └────────────────────┘
```

### Процесс записи

```
┌─────────────────────────┐
│ Начало записи           │
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Создание .lock          │◄─── Межпроцессная блокировка
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Запись в .tmp           │◄─── Не затрагивает основной файл
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Flush() на диск         │◄─── Гарантия записи
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Копирование в .backup   │◄─── Точка восстановления
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Замена .tmp → .json     │◄─── Атомарная операция
└───────────┬─────────────┘
            ▼
┌─────────────────────────┐
│ Удаление .backup, .lock │◄─── Успешное завершение
└─────────────────────────┘
```

## Формат данных

```json
[
  {
    "Type": "MariaDB",
    "Login": "user",
    "Server": "localhost",
    "Title": "На сервер localhost как user",
    "Hash": "[MariaDB]user@localhost"
  },
  {
    "Type": "QSCloud",
    "Login": "user",
    "Account": "company",
    "Title": "В облако company как user",
    "Hash": "[QSCloud]company\\user"
  }
]
```

